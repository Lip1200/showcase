name: Deploy to Infomaniak via FTP

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        run: |
          git clone ${{ secrets.REPO_URL }} .

      - name: Setup PHP
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-mbstring unzip curl
          php -v

      - name: Check PHP syntax
        run: |
          find . -name "*.php" -type f -print0 | xargs -0 -n1 php -l

      - name: Deploy via FTP
        run: |
          sudo apt-get install -y lftp
          lftp -e "set ftp:ssl-allow no; mirror -R ./ ${{ secrets.DEPLOY_PATH }}; bye" -u ${{ secrets.SSH_USER }},${{ secrets.SSH_PRIVATE_KEY }} ${{ secrets.DEPLOY_HOST }}
